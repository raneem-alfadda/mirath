// /api/gpt-analysis.ts

import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function POST(req: NextRequest) {
  try {
    const { data } = await req.json();

    const prompt = `
Ø£Ù†Øª Ù…Ø³ØªØ´Ø§Ø± Ù…Ø§Ù„ÙŠ Ù…Ø®Ø¶Ø±Ù…. Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ ØªÙ‚Ø¯ÙŠÙ… ØªÙ‚Ø±ÙŠØ± Ø§Ø³ØªØ´Ø§Ø±ÙŠ Ø´Ø§Ù…Ù„ Ø­ÙˆÙ„ Ø­Ø§Ù„Ø© Ø´Ø±ÙƒØ© Ø¹Ø§Ø¦Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©.

âœ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
- ÙƒØªØ§Ø¨Ø© ØªÙ‚Ø±ÙŠØ± Ø±Ø³Ù…ÙŠ ÙˆÙ…Ù‡Ù†ÙŠ ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø¶Ø­.
- Ø«Ù… ÙÙ‚Ø±Ø© ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ù„ÙŠ Ù…ÙØµÙ„ ØªØ´Ø±Ø­ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ØºØ© ØªØ­Ù„ÙŠÙ„ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ©.
- Ø¨Ø¹Ø¯Ù‡Ø§ ÙÙ‚Ø±Ø© ØªÙ‚ÙŠÙŠÙ… Ø¥Ø¯Ø§Ø±ÙŠ ØªÙˆØ¶Ù‘Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© (Ù…Ø«Ù„ Ø¶Ø¹Ù Ø§Ù„Ù‡ÙŠÙƒÙ„Ø©ØŒ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±ØŒ Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…ÙØ±Ø·...Ø¥Ù„Ø®).
- Ø«Ù… ÙÙ‚Ø±Ø© ØªÙˆØµÙŠØ§Øª Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ØªÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙˆØ±Ø«Ø© Ù†Ø­Ùˆ Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù„ÙƒÙŠØ© Ø¹Ø§Ø¯Ù„ ÙˆÙ…Ø³ØªÙ‚Ø± ÙˆÙ…Ø³ØªØ¯Ø§Ù….

ğŸ“Š Ø¨Ø¹Ø¯ Ø°Ù„ÙƒØŒ Ø£Ø¶Ù Ù‚Ø³Ù… Ù…Ù†ÙØµÙ„ Ø¨Ø¹Ù†ÙˆØ§Ù†: "Ø«Ø§Ù†ÙŠÙ‹Ø§: Ø°ÙƒØ§Ø¡ ÙØ¹Ù„ÙŠ (ØªØ­Ù„ÙŠÙ„ Ø±Ù‚Ù…ÙŠ)"
- Ø§Ø°ÙƒØ± ÙÙŠÙ‡ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙƒÙ†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ù…Ù† 100
- Ø§Ø°ÙƒØ± ÙÙŠÙ‡ Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± (Ù…Ø±ØªÙØ¹ØŒ Ù…ØªÙˆØ³Ø·ØŒ Ù…Ù†Ø®ÙØ¶)
- Ø£Ø¶Ù "Ù†Ù‚Ø·Ø© Ø§Ù„Ø¶Ø¹Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" ÙÙŠ Ø³Ø·Ø±ÙŠÙ† ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø­ Ù…Ø·ÙˆÙ„.

ğŸ§¾ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
- Ù†ÙˆØ¹ Ø§Ù„Ø´Ø±ÙƒØ©: ${data.companyType}
- Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„: ${data.capital}
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„: ${data.totalAssets}
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª: ${data.totalLiabilities}
- Ù†Ø³Ø¨Ø© Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­: ${data.profitMargin}%
- Ù†Ø³Ø¨Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: ${data.liquidityRatio}
- Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø¥Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„: ${data.debtEquity}
- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„: ${data.incomeStatement}
- Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©: ${data.balanceSheet}
- Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ±Ø«Ø©: ${data.heirCount}
- Ù‡Ù„ ØªÙˆØ¬Ø¯ ÙˆØµÙŠØ©ØŸ: ${data.hasWill}
- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ±Ø«Ø©:
${data.heirs.map((heir: any, i: number) => `  ${i + 1}. Ø§Ù„Ø§Ø³Ù…: ${heir.name} - Ø§Ù„Ø¹Ù…Ø±: ${heir.age} - ØµÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¨Ø©: ${heir.relation}`).join('\n')}

ğŸ“Œ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
- Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Markdown.
- Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ø¶Ø­Ø©: "Ø£ÙˆÙ„Ù‹Ø§: Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠ"ØŒ "Ø«Ø§Ù†ÙŠÙ‹Ø§: Ø°ÙƒØ§Ø¡ ÙØ¹Ù„ÙŠ".
- Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø¨Ø±Ø© Ø±Ø³Ù…ÙŠØ©ØŒ ÙˆÙƒØ£Ù†Ùƒ ØªÙ‚Ø¯Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø¬Ù‡Ø© Ù…ØµØ±ÙÙŠØ© Ø£Ùˆ Ù„Ø¬Ù†Ø© ÙˆØ±Ø«Ø©.
`;

    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: [{ role: 'user', content: prompt }],
    });

    const analysis = completion.choices[0].message.content;

    return NextResponse.json({ analysis });
  } catch (error) {
    console.error('Error in GPT analysis:', error);
    return NextResponse.json({ error: 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„' }, { status: 500 });
  }
}
